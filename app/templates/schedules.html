{% extends "base.html" %}

{% block title %}Backup Schedules — NetVault{% endblock %}
{% block header_title %}Backup Schedules{% endblock %}

{% block styles %}
{{ super() }}
.freq-badge { display:inline-block; padding:.2rem .6rem; border-radius:12px; font-size:.8rem; font-weight:600;
              background:#e8f0fe; color:#1e3c72; }
.modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                 background:rgba(0,0,0,.5); z-index:1000; }
.modal-box { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
             background:#fff; padding:2rem; border-radius:8px; width:90%; max-width:480px; }
.modal-box h3 { margin-bottom:1rem; color:#1e3c72; }
.field-row { display:flex; gap:.5rem; align-items:center; margin-top:.5rem; }
.field-row label { width:120px; font-weight:500; flex-shrink:0; }
.field-row input, .field-row select { flex:1; padding:.4rem .6rem; border:1px solid #ddd;
                                       border-radius:4px; font-size:.95rem; }
{% endblock %}

{% block content %}
<section class="section">
    <div class="btn-group" style="margin-bottom:1rem;">
        <button class="btn btn-primary" onclick="openCreate()">+ New Schedule</button>
    </div>

    <table class="table" id="sched-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Frequency</th>
                <th>Time</th>
                <th>Site</th>
                <th>Status</th>
                <th>Last Run</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="sched-tbody">
            <tr><td colspan="7" style="text-align:center;">Loading…</td></tr>
        </tbody>
    </table>
</section>

<!-- Create / Edit Modal -->
<div class="modal-overlay" id="sched-modal">
    <div class="modal-box">
        <h3 id="modal-title">New Schedule</h3>
        <input type="hidden" id="edit-id">

        <div class="form-group">
            <div class="field-row">
                <label>Name</label>
                <input id="f-name" type="text" placeholder="Daily full backup">
            </div>
            <div class="field-row">
                <label>Frequency</label>
                <select id="f-freq" onchange="updateTimeFields()">
                    <option value="hourly">Hourly (every hour at :00)</option>
                    <option value="daily" selected>Daily</option>
                    <option value="weekly">Weekly</option>
                </select>
            </div>
            <div class="field-row" id="row-hour">
                <label>Hour (UTC)</label>
                <input id="f-hour" type="number" min="0" max="23" value="2">
            </div>
            <div class="field-row" id="row-dow" style="display:none;">
                <label>Day</label>
                <select id="f-dow">
                    <option value="0">Monday</option>
                    <option value="1">Tuesday</option>
                    <option value="2">Wednesday</option>
                    <option value="3">Thursday</option>
                    <option value="4">Friday</option>
                    <option value="5">Saturday</option>
                    <option value="6">Sunday</option>
                </select>
            </div>
            <div class="field-row">
                <label>Site (optional)</label>
                <select id="f-site">
                    <option value="">All sites</option>
                </select>
            </div>
            <div class="field-row">
                <label>Enabled</label>
                <input id="f-enabled" type="checkbox" checked style="width:auto;flex:none;">
            </div>
        </div>

        <div class="btn-group" style="margin-top:1rem;">
            <button class="btn btn-primary" onclick="saveSchedule()">Save</button>
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
let _sites = [];

const DOW_NAMES = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

async function loadAll() {
    const [schedResp, siteResp] = await Promise.all([
        fetch('/api/schedules'),
        fetch('/api/sites'),
    ]);
    const schedules = await schedResp.json();
    _sites = await siteResp.json();

    // Populate site dropdown in modal
    const sel = document.getElementById('f-site');
    sel.innerHTML = '<option value="">All sites</option>';
    _sites.forEach(s => {
        const o = document.createElement('option');
        o.value = s.id;
        o.textContent = s.name;
        sel.appendChild(o);
    });

    renderSchedules(schedules);
}

function siteNameById(id) {
    const s = _sites.find(x => x.id === id);
    return s ? s.name : '—';
}

function renderSchedules(list) {
    const tbody = document.getElementById('sched-tbody');
    if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#888;">No schedules configured.</td></tr>';
        return;
    }
    tbody.innerHTML = list.map(s => {
        const timeStr = s.frequency === 'hourly' ? 'Every hour'
            : s.frequency === 'weekly' ? `${DOW_NAMES[s.day_of_week]} at ${String(s.hour).padStart(2,'0')}:00 UTC`
            : `Daily at ${String(s.hour).padStart(2,'0')}:00 UTC`;

        const lastRun = s.last_run_at ? new Date(s.last_run_at).toLocaleString() : 'Never';
        const statusBadge = s.enabled
            ? '<span class="badge badge-complete">Enabled</span>'
            : '<span class="badge badge-failed">Disabled</span>';

        return `<tr>
            <td><strong>${escHtml(s.name)}</strong></td>
            <td><span class="freq-badge">${s.frequency}</span></td>
            <td>${timeStr}</td>
            <td>${s.site_id ? escHtml(siteNameById(s.site_id)) : '<em>All sites</em>'}</td>
            <td>${statusBadge}</td>
            <td>${lastRun}</td>
            <td>
                <div style="display:flex;gap:4px;">
                    <button class="btn btn-sm btn-secondary" onclick="openEdit(${s.id})">Edit</button>
                    <button class="btn btn-sm btn-secondary" onclick="toggleSchedule(${s.id})">${s.enabled ? 'Disable' : 'Enable'}</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteSchedule(${s.id})">Delete</button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function updateTimeFields() {
    const freq = document.getElementById('f-freq').value;
    document.getElementById('row-hour').style.display = freq === 'hourly' ? 'none' : 'flex';
    document.getElementById('row-dow').style.display  = freq === 'weekly'  ? 'flex' : 'none';
}

function openCreate() {
    document.getElementById('modal-title').textContent = 'New Schedule';
    document.getElementById('edit-id').value = '';
    document.getElementById('f-name').value = '';
    document.getElementById('f-freq').value = 'daily';
    document.getElementById('f-hour').value = 2;
    document.getElementById('f-dow').value  = 0;
    document.getElementById('f-site').value = '';
    document.getElementById('f-enabled').checked = true;
    updateTimeFields();
    document.getElementById('sched-modal').style.display = 'block';
}

async function openEdit(id) {
    const resp = await fetch('/api/schedules');
    const list = await resp.json();
    const s = list.find(x => x.id === id);
    if (!s) return;

    document.getElementById('modal-title').textContent = 'Edit Schedule';
    document.getElementById('edit-id').value   = s.id;
    document.getElementById('f-name').value    = s.name;
    document.getElementById('f-freq').value    = s.frequency;
    document.getElementById('f-hour').value    = s.hour;
    document.getElementById('f-dow').value     = s.day_of_week;
    document.getElementById('f-site').value    = s.site_id || '';
    document.getElementById('f-enabled').checked = s.enabled;
    updateTimeFields();
    document.getElementById('sched-modal').style.display = 'block';
}

function closeModal() {
    document.getElementById('sched-modal').style.display = 'none';
}

async function saveSchedule() {
    const editId = document.getElementById('edit-id').value;
    const payload = {
        name:        document.getElementById('f-name').value.trim(),
        frequency:   document.getElementById('f-freq').value,
        hour:        parseInt(document.getElementById('f-hour').value) || 0,
        day_of_week: parseInt(document.getElementById('f-dow').value)  || 0,
        site_id:     document.getElementById('f-site').value ? parseInt(document.getElementById('f-site').value) : null,
        enabled:     document.getElementById('f-enabled').checked,
    };

    if (!payload.name) { alert('Name is required.'); return; }

    const url    = editId ? `/api/schedules/${editId}` : '/api/schedules';
    const method = editId ? 'PUT' : 'POST';

    const resp = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
    });

    if (!resp.ok) {
        const err = await resp.json();
        alert(`Error: ${err.detail || JSON.stringify(err)}`);
        return;
    }

    closeModal();
    loadAll();
}

async function toggleSchedule(id) {
    const resp = await fetch(`/api/schedules/${id}/toggle`, { method: 'POST' });
    if (!resp.ok) { alert('Error toggling schedule'); return; }
    loadAll();
}

async function deleteSchedule(id) {
    if (!confirm(`Delete schedule #${id}?`)) return;
    const resp = await fetch(`/api/schedules/${id}`, { method: 'DELETE' });
    if (resp.ok || resp.status === 204) { loadAll(); }
    else { alert('Error deleting schedule'); }
}

function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', () => {
    loadAll();
    document.getElementById('sched-modal').addEventListener('click', e => {
        if (e.target === document.getElementById('sched-modal')) closeModal();
    });
});
{% endblock %}
