{% extends "base.html" %}

{% block title %}Device Status — NetVault{% endblock %}
{% block header_title %}Device Status{% endblock %}

{% block styles %}
{{ super() }}
.search-bar { display:flex; gap:.5rem; align-items:center; margin-bottom:1rem; flex-wrap:wrap; }
.search-bar input { flex:1; min-width:200px; padding:.5rem .75rem; border:1px solid #ddd; border-radius:4px; font-size:.95rem; }
.search-bar input:focus { outline:none; border-color:#2a5298; box-shadow:0 0 0 2px rgba(42,82,152,.2); }
.pagination { display:flex; gap:.25rem; align-items:center; justify-content:center; margin-top:1rem; flex-wrap:wrap; }
.pagination button { padding:.3rem .65rem; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:.85rem; }
.pagination button:hover { background:#f0f4ff; }
.pagination button.active { background:#2a5298; color:#fff; border-color:#2a5298; }
.pagination button:disabled { opacity:.4; cursor:default; }
.total-info { font-size:.85rem; color:#666; margin-left:auto; }
.err-cell { max-width:260px; font-size:.8rem; color:#c00; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
{% endblock %}

{% block content %}
<section class="section">
    <div class="search-bar">
        <input id="search-input" type="text" placeholder="Search hostname, IP, site…" oninput="onSearchInput()">
        <button class="btn btn-primary btn-sm" onclick="loadStatus(1)">Search</button>
        <span class="total-info" id="total-info"></span>
    </div>

    <table class="table" id="status-table">
        <thead>
            <tr>
                <th>Hostname</th>
                <th>IP</th>
                <th>Platform</th>
                <th>Site</th>
                <th>Last Backup</th>
                <th>Status</th>
                <th>Error</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="status-tbody">
            <tr><td colspan="8" style="text-align:center;">Loading…</td></tr>
        </tbody>
    </table>

    <div class="pagination" id="pagination"></div>
</section>
{% endblock %}

{% block scripts %}
let _currentPage = 1;
let _searchDebounce = null;

function onSearchInput() {
    clearTimeout(_searchDebounce);
    _searchDebounce = setTimeout(() => loadStatus(1), 400);
}

async function loadStatus(page) {
    _currentPage = page;
    const search = document.getElementById('search-input').value.trim();
    const qs = new URLSearchParams({ page, page_size: 50 });
    if (search) qs.set('search', search);

    document.getElementById('status-tbody').innerHTML =
        '<tr><td colspan="8" style="text-align:center;color:#888;">Loading…</td></tr>';

    try {
        const resp = await fetch(`/api/devices/status?${qs}`);
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        renderRows(data.items);
        renderPagination(data.page, data.pages);
        document.getElementById('total-info').textContent =
            `${data.total.toLocaleString()} device${data.total !== 1 ? 's' : ''}`;
    } catch (e) {
        document.getElementById('status-tbody').innerHTML =
            `<tr><td colspan="8" style="color:#c00;padding:1rem;">Error: ${e.message}</td></tr>`;
    }
}

function renderRows(items) {
    const tbody = document.getElementById('status-tbody');
    if (!items.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#888;">No devices found.</td></tr>';
        return;
    }

    tbody.innerHTML = items.map(d => {
        const statusBadge = d.last_backup_status
            ? `<span class="badge badge-${d.last_backup_status === 'success' ? 'complete' : 'failed'}">${d.last_backup_status}</span>`
            : '<span style="color:#999;">Never</span>';

        const lastAt = d.last_backup_at
            ? new Date(d.last_backup_at).toLocaleString()
            : '—';

        const errCell = d.last_backup_error
            ? `<span class="err-cell" title="${escHtml(d.last_backup_error)}">${escHtml(d.last_backup_error)}</span>`
            : '—';

        const disabledMark = d.enabled ? '' : ' <span style="color:#999;font-size:.75rem;">(disabled)</span>';

        const actions = d.last_backup_status === 'success'
            ? `<div style="display:flex;gap:4px;">
                 <a class="btn btn-sm btn-primary" href="/config?device_id=${d.device_id}&platform=${d.platform}">Config</a>
                 <a class="btn btn-sm btn-secondary" href="/diff?device_id=${d.device_id}&platform=${d.platform}">Diff</a>
               </div>`
            : '—';

        return `<tr>
            <td><strong>${escHtml(d.hostname)}</strong>${disabledMark}</td>
            <td>${escHtml(d.ip)}</td>
            <td><code>${d.platform}</code></td>
            <td title="${escHtml(d.site_name)}">${escHtml(d.site_code)}</td>
            <td style="white-space:nowrap;">${lastAt}</td>
            <td>${statusBadge}</td>
            <td>${errCell}</td>
            <td>${actions}</td>
        </tr>`;
    }).join('');
}

function renderPagination(page, pages) {
    const el = document.getElementById('pagination');
    if (pages <= 1) { el.innerHTML = ''; return; }

    let html = `<button onclick="loadStatus(${page - 1})" ${page <= 1 ? 'disabled' : ''}>‹ Prev</button>`;

    // Show at most 7 page buttons around the current page
    const start = Math.max(1, page - 3);
    const end   = Math.min(pages, page + 3);
    if (start > 1) html += `<button onclick="loadStatus(1)">1</button>${start > 2 ? '<span>…</span>' : ''}`;
    for (let p = start; p <= end; p++) {
        html += `<button class="${p === page ? 'active' : ''}" onclick="loadStatus(${p})">${p}</button>`;
    }
    if (end < pages) html += `${end < pages - 1 ? '<span>…</span>' : ''}<button onclick="loadStatus(${pages})">${pages}</button>`;

    html += `<button onclick="loadStatus(${page + 1})" ${page >= pages ? 'disabled' : ''}>Next ›</button>`;
    el.innerHTML = html;
}

function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

document.addEventListener('DOMContentLoaded', () => loadStatus(1));
{% endblock %}
