{% extends "base.html" %}

{% block title %}Job #{{ job_id }} — AGNCF{% endblock %}
{% block header_title %}Backup Job Detail{% endblock %}

{% block content %}
<section class="section">
    <div class="btn-group" style="margin-bottom:1rem;">
        <a href="/dashboard" class="btn btn-secondary">← Back to Dashboard</a>
    </div>

    <div id="job-summary" style="margin-bottom:1.5rem;">
        <p style="color:#888;">Loading job #{{ job_id }}…</p>
    </div>
</section>

<section class="section">
    <h2>Device Results</h2>
    <table class="table" id="results-table">
        <thead>
            <tr>
                <th>Device</th>
                <th>Platform</th>
                <th>Status</th>
                <th>Duration</th>
                <th>Commit SHA</th>
                <th>Error</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="results-tbody">
            <tr><td colspan="7" style="text-align:center;">Loading…</td></tr>
        </tbody>
    </table>
</section>
{% endblock %}

{% block scripts %}
const jobId = {{ job_id }};
let deviceMap = {};

async function loadJobDetail() {
    try {
        const [jobRes, devRes] = await Promise.all([
            fetch(`/api/backups/jobs/${jobId}`),
            fetch('/api/devices'),
        ]);
        const job     = await jobRes.json();
        const devices = await devRes.json();

        devices.forEach(d => { deviceMap[d.id] = d; });
        renderSummary(job);
        renderResults(job.results);
    } catch (e) {
        document.getElementById('job-summary').innerHTML =
            `<div class="alert alert-error">Failed to load job: ${e.message}</div>`;
    }
}

function renderSummary(job) {
    const progress  = job.total_devices > 0
        ? (job.completed_devices / job.total_devices * 100).toFixed(0) : 0;
    const duration  = job.started_at && job.completed_at
        ? formatDuration(new Date(job.completed_at) - new Date(job.started_at)) : '—';

    document.getElementById('job-summary').innerHTML = `
        <h2>Job #${job.id}</h2>
        <div style="display:flex;gap:2rem;flex-wrap:wrap;margin-top:.75rem;">
            <div><strong>Status:</strong> <span class="badge badge-${job.status}">${job.status}</span></div>
            <div><strong>Triggered by:</strong> ${job.triggered_by}</div>
            <div><strong>Started:</strong> ${job.started_at ? formatDate(job.started_at) : '—'}</div>
            <div><strong>Duration:</strong> ${duration}</div>
            <div><strong>Progress:</strong> ${job.completed_devices}/${job.total_devices} (${progress}%)</div>
            <div><strong>Failed:</strong> ${job.failed_devices}</div>
        </div>
    `;
}

function renderResults(results) {
    const tbody = document.getElementById('results-tbody');
    if (!results || results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No results yet.</td></tr>';
        return;
    }

    tbody.innerHTML = results.map(r => {
        const dev      = deviceMap[r.device_id] || {};
        const hostname = dev.hostname || `Device #${r.device_id}`;
        const platform = dev.platform || '—';
        const sha      = r.gitea_commit_sha ? r.gitea_commit_sha.slice(0, 10) : '—';
        const dur      = r.duration_seconds != null ? `${r.duration_seconds.toFixed(1)}s` : '—';
        const err      = r.error_message
            ? `<span style="color:#c00;font-size:.85rem;" title="${r.error_message}">${r.error_message.slice(0, 60)}${r.error_message.length > 60 ? '…' : ''}</span>`
            : '—';

        const actions = r.status === 'success'
            ? `<div style="display:flex;gap:4px;">
                 <a class="btn btn-sm btn-primary" href="/config?device_id=${r.device_id}&platform=${platform}">View Config</a>
                 <a class="btn btn-sm btn-secondary" href="/diff?device_id=${r.device_id}&platform=${platform}">View Diff</a>
               </div>`
            : '—';

        return `
            <tr>
                <td><strong>${hostname}</strong></td>
                <td>${platform}</td>
                <td><span class="badge badge-${r.status === 'success' ? 'complete' : 'failed'}">${r.status}</span></td>
                <td>${dur}</td>
                <td><code>${sha}</code></td>
                <td>${err}</td>
                <td>${actions}</td>
            </tr>
        `;
    }).join('');
}

function formatDate(s) { return new Date(s).toLocaleString(); }

function formatDuration(ms) {
    const s = Math.floor(ms / 1000);
    const m = Math.floor(s / 60);
    const h = Math.floor(m / 60);
    if (h > 0) return `${h}h ${m % 60}m`;
    if (m > 0) return `${m}m ${s % 60}s`;
    return `${s}s`;
}

document.addEventListener('DOMContentLoaded', loadJobDetail);
{% endblock %}
