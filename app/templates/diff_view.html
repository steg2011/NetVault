{% extends "base.html" %}

{% block title %}Config Diff - AGNCF{% endblock %}

{% block header_title %}Configuration Diff Viewer{% endblock %}

{% block styles %}
    {{ super() }}
    .diff-container {
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        line-height: 1.5;
    }

    .diff-header {
        background: #333;
        color: white;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #666;
        font-weight: bold;
    }

    .diff-lines {
        display: table;
        width: 100%;
    }

    .diff-line {
        display: table-row;
    }

    .diff-linenum {
        display: table-cell;
        width: 60px;
        padding: 0 0.5rem;
        text-align: right;
        background: #eee;
        color: #666;
        border-right: 1px solid #ccc;
        user-select: none;
    }

    .diff-content {
        display: table-cell;
        padding: 0 1rem;
        width: 100%;
        word-break: break-all;
    }

    .diff-line.added {
        background: #d4edda;
    }

    .diff-line.added .diff-content {
        color: #155724;
    }

    .diff-line.removed {
        background: #f8d7da;
    }

    .diff-line.removed .diff-content {
        color: #721c24;
    }

    .diff-line.context .diff-content {
        color: #333;
    }

    .diff-line.header {
        background: #e7f3ff;
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
    }

    .diff-line.header .diff-content {
        color: #0066cc;
        font-weight: bold;
        padding: 0.75rem 1rem;
    }
{% endblock %}

{% block content %}

<section class="section">
    <h2 id="device-name">Configuration Diff</h2>
    <div class="btn-group">
        <button class="btn btn-secondary" onclick="goBack()">Back to Device</button>
        <button class="btn btn-secondary" onclick="downloadDiff()">Download Diff</button>
        <button class="btn btn-secondary" onclick="refreshDiff()">Refresh</button>
    </div>
</section>

<section class="section">
    <div id="diff-viewer" class="diff-container">
        <div style="text-align: center; padding: 2rem; color: #666;">Loading diff...</div>
    </div>
</section>

{% endblock %}

{% block scripts %}

let currentDeviceId = new URLSearchParams(window.location.search).get('device_id');
let currentDiff = '';

async function loadDiff() {
    if (!currentDeviceId) {
        document.getElementById('diff-viewer').innerHTML = '<div style="padding: 1rem; color: red;">No device ID provided</div>';
        return;
    }

    try {
        const response = await fetch(`/api/backups/diff/${currentDeviceId}`);
        const data = await response.json();

        document.getElementById('device-name').textContent = `Configuration Diff - ${data.hostname}`;
        currentDiff = data.unified_diff;

        renderDiff(data.unified_diff);
    } catch (e) {
        console.error('Failed to load diff:', e);
        document.getElementById('diff-viewer').innerHTML = `<div style="padding: 1rem; color: red;">Error loading diff: ${e.message}</div>`;
    }
}

function renderDiff(unifiedDiff) {
    if (!unifiedDiff || unifiedDiff.trim().length === 0) {
        document.getElementById('diff-viewer').innerHTML = '<div style="padding: 1rem; color: #666;">No differences found</div>';
        return;
    }

    const lines = unifiedDiff.split('\n');
    let lineNum = 0;
    let html = '<div class="diff-header">Unified Diff</div><div class="diff-lines">';

    lines.forEach((line, idx) => {
        let className = 'context';
        let display = line;

        if (line.startsWith('+++') || line.startsWith('---')) {
            className = 'header';
        } else if (line.startsWith('+')) {
            className = 'added';
            display = line.substring(1);
        } else if (line.startsWith('-')) {
            className = 'removed';
            display = line.substring(1);
        } else if (line.startsWith('@@')) {
            className = 'header';
            display = line;
        } else {
            display = line;
        }

        lineNum++;
        const safeDisplay = escapeHtml(display);

        html += `
            <div class="diff-line ${className}">
                <div class="diff-linenum">${lineNum}</div>
                <div class="diff-content">${safeDisplay}</div>
            </div>
        `;
    });

    html += '</div>';
    document.getElementById('diff-viewer').innerHTML = html;
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function downloadDiff() {
    if (!currentDiff) {
        alert('No diff available');
        return;
    }

    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(currentDiff));
    element.setAttribute('download', `diff-${currentDeviceId}.patch`);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

function refreshDiff() {
    loadDiff();
}

function goBack() {
    history.back();
}

document.addEventListener('DOMContentLoaded', loadDiff);

{% endblock %}
