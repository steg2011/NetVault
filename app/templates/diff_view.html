{% extends "base.html" %}

{% block title %}Config Diff — AGNCF{% endblock %}
{% block header_title %}Configuration Diff Viewer{% endblock %}

{% block styles %}
{{ super() }}

.diff-toolbar { margin-bottom: 1rem; display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; }
.diff-meta { font-size: .85rem; color: #555; flex: 1; }
.diff-container {
    background: #1e1e1e; border-radius: 6px; overflow: hidden;
    font-family: 'Courier New', Consolas, monospace; font-size: .82rem; line-height: 1.5;
    border: 1px solid #333;
}
.diff-file-header {
    background: #2d2d2d; color: #ccc; padding: .4rem 1rem;
    border-bottom: 1px solid #444; font-weight: bold; font-size: .8rem;
}
.diff-table { width: 100%; border-collapse: collapse; }
.diff-table td { padding: 0 .5rem; vertical-align: top; white-space: pre-wrap; word-break: break-all; }
.ln { width: 48px; text-align: right; color: #555; border-right: 1px solid #333;
      user-select: none; padding-right: .4rem; }
.code-cell { width: 100%; }
.line-add    { background: #1a3a1a; }
.line-add    .code-cell { color: #98c379; }
.line-add    .ln  { background: #1a2e1a; color: #4a8a4a; }
.line-del    { background: #3a1a1a; }
.line-del    .code-cell { color: #e06c75; }
.line-del    .ln  { background: #2e1a1a; color: #8a4a4a; }
.line-hunk   { background: #1a2a3a; }
.line-hunk   .code-cell { color: #61aeee; font-weight: bold; }
.line-hunk   .ln  { background: #1a2233; color: #4a6a9a; }
.line-file   { background: #2a2a00; }
.line-file   .code-cell { color: #e5c07b; font-weight: bold; }
.line-file   .ln  { background: #222200; }
.line-ctx    { }
.line-ctx    .code-cell { color: #abb2bf; }
.line-ctx    .ln  { color: #444; }

/* ── Inline syntax highlight tokens ── */
.kw  { color: #c678dd; font-weight: bold; }   /* keywords */
.kw2 { color: #56b6c2; }                       /* secondary keywords */
.str { color: #98c379; }                       /* strings / values */
.num { color: #d19a66; }                       /* numbers / IPs */
.cmt { color: #5c6370; font-style: italic; }   /* comments */
.xml-tag  { color: #e06c75; }
.xml-attr { color: #e5c07b; }
.xml-val  { color: #98c379; }
{% endblock %}

{% block content %}
<section class="section">
    <h2 id="diff-title">Configuration Diff</h2>

    <div class="diff-toolbar">
        <button class="btn btn-secondary btn-sm" onclick="history.back()">← Back</button>
        <button class="btn btn-secondary btn-sm" onclick="loadDiff()">Refresh</button>
        <button class="btn btn-secondary btn-sm" onclick="downloadDiff()">Download .patch</button>
        <span class="diff-meta" id="diff-meta"></span>
    </div>

    <div id="diff-container" class="diff-container">
        <div style="padding:2rem;color:#888;text-align:center;">Loading diff…</div>
    </div>
</section>
{% endblock %}

{% block scripts %}
/* ─────────────────────────────────────────────────────────────────────────────
   Bundled lightweight syntax highlighter for network device configurations.
   No external dependencies — no CDN, no npm.
   ───────────────────────────────────────────────────────────────────────────── */
const Highlighter = (() => {
    const e = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    /* IOS / NX-OS / EOS / OS10 keywords */
    const CLI_KW = /\b(interface|router|ip|ipv6|route|access-list|permit|deny|no|shutdown|description|hostname|version|vlan|spanning-tree|crypto|pki|certificate|ntp|logging|snmp|service|line|console|vty|password|username|enable|aaa|authentication|authorization|accounting|policy-map|class-map|match|set|traffic-shape|bandwidth|delay|reliability|load|mtu|duplex|speed|switchport|access|trunk|encapsulation|dot1q|bgp|ospf|eigrp|rip|area|network|neighbor|redistribute|default-information|originate|passive-interface|maximum-paths|timers|bfd|mpls|ldp|vrf|definition|address-family|import|export|route-target|route-distinguisher|prefix-list|community|local-preference|weight|aggregate-address)\b/g;

    /* secondary / modifier keywords */
    const CLI_KW2 = /\b(in|out|any|host|eq|gt|lt|neq|range|established|log|reflect|evaluate|remark|static|dynamic|extended|standard|named|ip-access|arp|proxy|directed-broadcast|source-route|classless|default|metric|administrative|distance)\b/g;

    /* Fortinet / PAN-OS XML tag names */
    const XML_TAG = /(&lt;\/?)([\w-]+)(&gt;|[\s>])/g;

    /* IPv4 addresses and CIDR prefixes */
    const IP_RE = /\b(\d{1,3}\.){3}\d{1,3}(\/\d{1,2})?\b/g;

    /* Numbers (standalone) */
    const NUM_RE = /(?<![.\w])(\d+)(?![.\w])/g;

    /* Shell / IOS comments */
    const CMT_RE = /^(\s*[!#].*)$/gm;

    function highlightCLI(line) {
        let s = e(line);
        s = s.replace(CMT_RE, m => `<span class="cmt">${m}</span>`);
        s = s.replace(CLI_KW,  m => `<span class="kw">${m}</span>`);
        s = s.replace(CLI_KW2, m => `<span class="kw2">${m}</span>`);
        s = s.replace(IP_RE,   m => `<span class="num">${m}</span>`);
        return s;
    }

    function highlightXML(line) {
        let s = e(line);
        /* Highlight tag names */
        s = s.replace(/(&lt;\/?)([\w:-]+)(&gt;|[ \t])/g,
            (_, open, tag, close) =>
                `${open}<span class="xml-tag">${tag}</span>${close}`);
        /* Highlight attribute values */
        s = s.replace(/([\w:-]+)(=)(&quot;[^&]*&quot;)/g,
            (_, attr, eq, val) =>
                `<span class="xml-attr">${attr}</span>${eq}<span class="xml-val">${val}</span>`);
        return s;
    }

    function highlightFortios(line) {
        let s = e(line);
        s = s.replace(/\b(config|edit|set|end|next|get|show|diagnose|execute)\b/g,
            m => `<span class="kw">${m}</span>`);
        s = s.replace(IP_RE, m => `<span class="num">${m}</span>`);
        return s;
    }

    return {
        highlight(line, platform) {
            if (!line) return '';
            if (platform === 'panos') return highlightXML(line);
            if (platform === 'fortios') return highlightFortios(line);
            return highlightCLI(line);   /* ios, nxos, eos, dellos10 */
        }
    };
})();

/* ─────────────────────────────────────────────────────────────────────────────
   Diff renderer
   ───────────────────────────────────────────────────────────────────────────── */
const params   = new URLSearchParams(window.location.search);
const deviceId = params.get('device_id');
let rawDiff    = '';
let platform   = params.get('platform') || 'ios';

async function loadDiff() {
    if (!deviceId) {
        document.getElementById('diff-container').innerHTML =
            '<div style="padding:2rem;color:#f00;">No device_id in query string.</div>';
        return;
    }

    document.getElementById('diff-container').innerHTML =
        '<div style="padding:2rem;color:#888;text-align:center;">Loading…</div>';

    try {
        const r    = await fetch(`/api/backups/diff/${deviceId}`);
        const data = await r.json();

        document.getElementById('diff-title').textContent =
            `Configuration Diff — ${data.hostname}`;

        rawDiff  = data.unified_diff || '';
        platform = data.platform || platform;

        renderDiff(rawDiff);

    } catch (err) {
        document.getElementById('diff-container').innerHTML =
            `<div style="padding:2rem;color:#f00;">Error: ${err.message}</div>`;
    }
}

function renderDiff(unifiedDiff) {
    const container = document.getElementById('diff-container');

    if (!unifiedDiff || !unifiedDiff.trim()) {
        container.innerHTML =
            '<div style="padding:2rem;color:#888;text-align:center;">No differences found.</div>';
        return;
    }

    const lines     = unifiedDiff.split('\n');
    let   addCount  = 0;
    let   delCount  = 0;
    let   lineNum   = 0;
    let   html      = '<table class="diff-table">';

    for (const line of lines) {
        lineNum++;
        let rowClass  = 'line-ctx';
        let prefix    = '';
        let content   = line;

        if (line.startsWith('+++') || line.startsWith('---')) {
            rowClass = 'line-file';
        } else if (line.startsWith('@@')) {
            rowClass = 'line-hunk';
        } else if (line.startsWith('+')) {
            rowClass = 'line-add';
            prefix   = '+';
            content  = line.slice(1);
            addCount++;
        } else if (line.startsWith('-')) {
            rowClass = 'line-del';
            prefix   = '-';
            content  = line.slice(1);
            delCount++;
        }

        const highlighted = (rowClass === 'line-add' || rowClass === 'line-del' || rowClass === 'line-ctx')
            ? Highlighter.highlight(content, platform)
            : Highlighter.highlight(content, platform);

        html += `<tr class="${rowClass}">` +
                `<td class="ln">${lineNum}</td>` +
                `<td class="code-cell">${prefix ? `<span style="opacity:.6">${prefix}</span>` : ''}${highlighted}</td>` +
                `</tr>`;
    }

    html += '</table>';

    const meta = `+${addCount} / -${delCount} lines changed`;
    document.getElementById('diff-meta').textContent = meta;
    container.innerHTML = '<div class="diff-file-header">Unified Diff</div>' + html;
}

function downloadDiff() {
    if (!rawDiff) { alert('No diff to download.'); return; }
    const a = document.createElement('a');
    a.href     = 'data:text/plain;charset=utf-8,' + encodeURIComponent(rawDiff);
    a.download = `diff-device-${deviceId}.patch`;
    a.click();
}

document.addEventListener('DOMContentLoaded', loadDiff);
{% endblock %}
